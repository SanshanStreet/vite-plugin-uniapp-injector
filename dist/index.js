/**
 * vite-plugin-uniapp-injector v1.0.9
 * (c) 2025 Jeddy
 * Released under the MIT License.
 */
import j, { resolve } from 'path';
import { Logger } from 'tslog';
import X from 'fs';
import { parse, MagicString } from '@vue/compiler-sfc';

var L=Symbol("singleComment"),x=Symbol("multiComment"),B=()=>"",J=(e,t,r)=>e.slice(t,r).replace(/\S/g," "),G=(e,t)=>{let r=t-1,n=0;for(;e[r]==="\\";)r-=1,n+=1;return !!(n%2)};function I(e,{whitespace:t=!0,trailingCommas:r=!1}={}){if(typeof e!="string")throw new TypeError(`Expected argument \`jsonString\` to be a \`string\`, got \`${typeof e}\``);let n=t?J:B,c=!1,a=!1,s=0,o="",p="",f=-1;for(let i=0;i<e.length;i++){let l=e[i],g=e[i+1];if(!a&&l==='"'&&(G(e,i)||(c=!c)),!c)if(!a&&l+g==="//")o+=e.slice(s,i),s=i,a=L,i++;else if(a===L&&l+g===`\r
`){i++,a=!1,o+=n(e,s,i),s=i;continue}else if(a===L&&l===`
`)a=!1,o+=n(e,s,i),s=i;else if(!a&&l+g==="/*"){o+=e.slice(s,i),s=i,a=x,i++;continue}else if(a===x&&l+g==="*/"){i++,a=!1,o+=n(e,s,i+1),s=i+1;continue}else r&&!a&&(f!==-1?l==="}"||l==="]"?(o+=e.slice(s,i),p+=n(o,0,1)+o.slice(1),o="",s=i,f=-1):l!==" "&&l!=="	"&&l!=="\r"&&l!==`
`&&(o+=e.slice(s,i),s=i,f=-1):l===","&&(p+=o+e.slice(s,i),o="",s=i,f=i));}return p+o+(a?n(e.slice(s)):e.slice(s))}function S(e){return !!e&&typeof e=="object"&&"path"in e}function v(e){return !!e&&typeof e=="object"&&"root"in e&&"pages"in e&&Array.isArray(e.pages)}function O(e,t){return resolve(e,`${t}.vue`).replace(/\\/g,"/")}var y=new Logger({name:"vite-inset-loader",minLevel:3,type:"pretty",hideLogPositionForProduction:!0,prettyLogTimeZone:"local",prettyLogTemplate:"{{yyyy}}.{{mm}}.{{dd}} {{hh}}:{{MM}}:{{ss}}	{{logLevelName}}	"}),h=class{constructor(){this.rootOption=null;this.pagesList=null;}static getInstance(){return h.instance||(h.instance=new h),h.instance}setRootOption(t){this.rootOption=t;}getRootOption(){if(!this.rootOption)throw new Error("Root options not initialized");return this.rootOption}setPagesList(t){this.pagesList=t;}getPagesList(){if(!this.pagesList)throw new Error("Pages list not initialized");return this.pagesList}},T=h.getInstance();function q(e){try{let t=X.readFileSync(e,"utf-8"),r=I(t);return JSON.parse(r)}catch(t){throw new Error(`Failed to parse pages.json: ${t instanceof Error?t.message:String(t)}`)}}var w=(e,t,r)=>{try{T.setRootOption(r);let n=q(e);T.setPagesList(n);let c=new Set;return (n.pages||[]).filter(S).forEach(a=>c.add(O(t,a.path))),(n.subPackages||[]).filter(v).forEach(a=>{let s=resolve(t,a.root);a.pages.filter(S).forEach(o=>c.add(O(s,o.path)));}),Array.from(c)}catch(n){throw new Error(`\u521D\u59CB\u5316\u5931\u8D25: ${n instanceof Error?n.message:String(n)}`)}},N=()=>{let e=h.getInstance(),t=e.getPagesList(),r=e.getRootOption(),{components:n,insertPos:c={}}=r,{mode:a="GLOBAL",exclude:s=[],handlePos:o=[]}=c,p=g=>"/"+g.split("/").filter(Boolean).join("/"),f=()=>{let g=[];return (t.pages||[]).filter(S).forEach(u=>g.push({path:p(u.path),config:u})),(t.subPackages||[]).filter(v).forEach(u=>{u.pages.filter(S).forEach(C=>g.push({path:p(`${u.root}/${C.path}`),config:C,root:u.root}));}),g},i={},l=f();if(l.forEach(({path:g})=>{i[g]={label:[]};}),a==="GLOBAL"&&n){let g=Object.keys(n);l.forEach(({path:u})=>{let C=u.startsWith("/")?u:`/${u}`;if(s.some(P=>C===(P.startsWith("/")?P:`/${P}`)))return;let M=o.find(P=>{var R;return C===((R=P.page)!=null&&R.startsWith("/")?P.page:`/${P.page}`)});i[u]={label:(M==null?void 0:M.insert)??g};});}return i},z=(e,t)=>{try{let r=e.replace(/\\/g,"/"),n=t.replace(r,"").replace(/\\/g,"/");return n.endsWith(".vue")?n.slice(0,-4):n}catch(r){return y.error(`\u8DEF\u5F84\u5904\u7406\u5931\u8D25: ${r instanceof Error?r.message:String(r)}`),null}},A=e=>{try{if(!Array.isArray(e)||e.length===0)return "";let t=h.getInstance(),{components:r}=t.getRootOption();return !r||Object.keys(r).length===0?"":e.filter(n=>n&&typeof n=="string"&&n in r).map(n=>r[n]).join(`
`)}catch(t){return y.error(`\u751F\u6210\u7EC4\u4EF6DOM\u5931\u8D25: ${t instanceof Error?t.message:String(t)}`),""}},d=class{static generateHtml(t,r){try{if(!t)return "";let n=t.replace(this.PAGE_META_REGEX,"").replace(this.COMMENT_REGEX,"").trim();return !r&&!n?"":[r,n,""].filter(Boolean).join(`
`)}catch(n){return y.error(`HTML\u751F\u6210\u5931\u8D25: ${n instanceof Error?n.message:String(n)}`),t}}static extractPageMeta(t){try{let r=t.match(/<(?:page-meta|PageMeta|pageMeta)\b[^>]*(?:\/>|>([\s\S]*?)<\/\1)/i);return r?r[0]:""}catch(r){return y.error(`\u9875\u9762\u5143\u6570\u636E\u63D0\u53D6\u5931\u8D25: ${r instanceof Error?r.message:String(r)}`),""}}};d.PAGE_META_REGEX=/<(?:page-meta|PageMeta|pageMeta)\b[^>]*(?:\/>|>([\s\S]*?)<\/\1)/gi,d.COMMENT_REGEX=/<!--(?!.*?(?:#ifdef|#ifndef|#endif)).*?-->/g;var E=class{static generateStyle(t){try{return !Array.isArray(t)||t.length===0?"":t.map(r=>{let n=[r.lang&&`lang="${r.lang}"`,r.scoped&&"scoped"].filter(Boolean).join(" ");return `<style${n?` ${n}`:""}>
${r.content}
</style>`}).join(`
`)}catch(r){return y.error(`\u6837\u5F0F\u751F\u6210\u5931\u8D25: ${r instanceof Error?r.message:String(r)}`),""}}},b=class{static generateScript(t){try{let r=[t.lang&&`lang="${t.lang}"`,t.setup&&"setup"].filter(Boolean).join(" ");return `<script${r?` ${r}`:""}>
${t.content}
</script>`}catch(r){return y.error(`\u811A\u672C\u751F\u6210\u5931\u8D25: ${r instanceof Error?r.message:String(r)}`),""}}},F=d.generateHtml.bind(d),k=d.extractPageMeta.bind(d),D=E.generateStyle.bind(E),$=b.generateScript.bind(b);var _=(e,t,r)=>{let{descriptor:n,error:c}=Y(e,t);if(c||!n)return {code:t,map:null,errors:c?[c]:["\u65E0\u6CD5\u89E3\u6790 SFC \u6587\u4EF6"]};try{let{template:a,pageMeta:s,style:o,scriptSetup:p,script:f}=tt(n,r),i=et({template:a,pageMeta:s,descriptor:n,style:o,scriptSetup:p,script:f});return nt(e,t,i)}catch(a){return {code:t,map:null,errors:[`\u8F6C\u6362\u8FC7\u7A0B\u51FA\u9519: ${a instanceof Error?a.message:String(a)}`]}}},Y=(e,t)=>{try{return {descriptor:parse(t).descriptor}}catch(r){return {descriptor:null,error:`[SFC\u89E3\u6790\u9519\u8BEF] ${e}
\u9519\u8BEF\u4FE1\u606F: ${r instanceof Error?r.message:String(r)}`}}},tt=(e,t)=>{var f;let r=((f=e.template)==null?void 0:f.content)||"",n=A(t.label),c=F(r,n),a=k(r),s=D(e.styles||[]),o=e.scriptSetup?$(e.scriptSetup):null,p=e.script?$(e.script):null;return {template:c,pageMeta:a,style:s,scriptSetup:o,script:p}},et=({template:e,pageMeta:t,descriptor:r,style:n,scriptSetup:c,script:a})=>{let s=rt(r);return ["<template>",t,e,"</template>",s,c||"",a||"",n||""].join(`
`).trim()},rt=e=>{let t=e.source,r=/<script\s+module="[^"]*"\s+lang="(?:wxs|sjs|filter\.js)"(?:\s+src="[^"]*")?\s*(?:\/>|>([\s\S]*?)<\/script>)/g,n,c=[];for(;(n=r.exec(t))!==null;)c.push(n[0]);return c.join(`
`)},nt=(e,t,r)=>{let n=new MagicString(t);return n.overwrite(0,t.length,r),{code:n.toString(),map:n.generateMap({source:e,hires:!0,includeContent:!1})}};var W={TRANSFORM_LOG_INTERVAL:20,VUE_FILE_REGEX:/\.vue$/},m=new Logger({name:"vite-inset-loader",minLevel:3,type:"pretty",hideLogPositionForProduction:!0,prettyLogTimeZone:"local",prettyLogTemplate:"{{yyyy}}.{{mm}}.{{dd}} {{hh}}:{{MM}}:{{ss}}	{{logLevelName}}	"}),V=(e={insertPos:{mode:"GLOBAL"}})=>{let t={pagesMap:{},isInitialized:!1,totalPages:0,transformCount:0},r=()=>{let s=process.env.UNI_INPUT_DIR||`${process.env.INIT_CWD}/src`;if(!s||s.trim()==="")throw new Error("Missing required environment variables: UNI_INPUT_DIR or INIT_CWD");return {rootPath:j.resolve(s),pagesPath:j.resolve(s,"pages.json")}},n=()=>{try{let{rootPath:s,pagesPath:o}=r();w(o,s,e),t.pagesMap=N(),t.totalPages=Object.keys(t.pagesMap).length,t.isInitialized=!0,t.totalPages>0?m.info(`Initialized ${t.totalPages} pages`):m.warn("No pages found in pages.json");}catch(s){m.error("Initialization failed:",s),c();}},c=()=>{t.pagesMap={},t.isInitialized=!1,t.totalPages=0,t.transformCount=0;},a=()=>{let{transformCount:s,totalPages:o}=t;if(s%W.TRANSFORM_LOG_INTERVAL===0||s===o){let p=Math.min(100,Math.round(s/o*100));m.debug(`Processing pages... ${s}/${o} (${p}%)`);}};return {name:"vite-inset-loader",buildStart(){if(m.debug("Starting build initialization"),t.isInitialized){m.trace("Already initialized, skipping");return}n();},watchChange(s,o){o.event==="update"&&s.includes("pages.json")&&(m.info("Detected pages.json update, reinitializing"),n());},async transform(s,o){if(!W.VUE_FILE_REGEX.test(o))return {code:s,map:null};if(!t.isInitialized)return m.warn("Plugin not initialized, skipping transform"),{code:s,map:null};try{let{rootPath:p}=r(),f=z(p,o);if(!f)return m.silly(`No route match for ${o}`),{code:s,map:null};let i=t.pagesMap[f];if(!i)return m.silly(`No page config found for route: ${f}`),{code:s,map:null};t.transformCount++,a();let l=await _(o,s,i),g=l.map;return {code:l.code,map:g&&{version:3,file:o,mappings:g.mappings,sources:g.sources,names:g.names},...l.errors?{errors:l.errors}:{}}}catch(p){return m.error(`Transform failed for ${o}:`,p),{code:s,map:null}}}}};var Lt=V;

export { Lt as default };
//# sourceMappingURL=out.js.map
//# sourceMappingURL=index.js.map